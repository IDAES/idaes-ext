# General Helmholz Equation of State (EoS) Functions

## Overview

The general Helmholtz library provides functions for calculating thermodynamic properties 
based on Helmholtz equations of state, changing state, and phase equilibrium. For example 
see:

Wagner, W.,  A. Pruss (2002). "The IAPWS Formulation 1995 for the
    Thermodynamic Properties of Ordinary Water Substance for General and
    Scientific Use." J. Phys. Chem. Ref. Data, 31, 387-535.

The Helmholtz EoS provides high-accuracy thermodynamic properties for pure components and
azeotropic mixtures, and is used in NIST's RefProp (https://refprop-docs.readthedocs.io/en/latest/).
Thermodynamic properties are calculated from Helmholtz free energy correlations split into
ideal and residual parts and their first and second derivatives.  Both parts are written as functions 
of density and temperature.  The IDAES function library does not prescribe a fixed form for these 
correlations, and they can be provided as NL files 
(https://portal.ampl.com/docs/archive/first-website/REFS/hooking2.pdf) generated by Pyomo
(https://pyomo.readthedocs.io/en/stable/).

An AMPL user-defined function wrapper (https://portal.ampl.com/docs/archive/first-website/REFS/hooking2.pdf)
is provied which returns first and second deviravaties for Pyomo and AMPL solvers such as the AMPL 
interface for Ipopt (https://coin-or.github.io/Ipopt/). Since density and temperature are not the most
convenient choice of state varaibles, functions are also provied which allow (temperature, pressure, 
vapor fraction), (enthalpy, pressure), (entropy, pressure), and (internal energy and pressure) to be used as
state varaibles. 

The purpose of provideing the user-defined functions rather than including the EoS equations directly in a
process model is to provide a form of problem decomposition, where a subset of model equations related to
phase equilibrium and change of state varaibles can be solved more easily by allowing proceedural and 
specialized solvers to ensure the correct result is obtained, generally making overall process model 
simpler and more robust.  The user-defined functions also return the exact first and second derivatives 
required by advanced optimization solvers, so the advantage of equation-oriented modeling is not lost.

## Building

There are build scripts and doceker containers provided, so that the Helmholtz EoS functions can be build
along with solvers and other IDAES libraries. If you want to build only the Helmholtz libraies, the Makefile
can be used in an MSYS2 MinGW environment.  The AMPL Solver Library (ASL) is required 
(https://netlib.org/ampl/solvers/). Once you build the ASL, you can edit the Makefile to specify the `lib` 
and `include` directories for the ASL. Boost is also required (https://www.boost.org). Depending on you
boost install, you may also need to add the boost location to the Makefile.

## Testing

When you run make, it should build the shared library and build and run a test executable.  The test 
execuatable reads a list of tests to run from the `test_data` directory and test function results
against data in CSV file.  The data is taken from NIST Chemistry Webbook ().  Since the equations of 
state used for the IDAES functions and the NIST functions, the results should generally march.  For 
liquids, over some range there are not enough significant figure provied for density and pressure
to accuratly calculate properties to compare, since the liquid density is not very sensitive to pressure.
The area around the critical point can also be challnging to solve with high accuracy. If any tests 
fail the result of make will be a nonzero exit code. 

To add tests you can follow the example of the existing tests.

## Adding components.

To add a component you must provided the Helmholtz free energy correlations, some paraemters, and auxilary
equations for an initial guess of saturated liquid and vapor density based on temperature.  The expression 
and parameter files are geenrated via Python script.  Examples of this can be found in the `param_data`
directory.

## Usage

The primary use of these function is throguh the ASL interface and the property pacakge wrapper in IDAES
(https://github.com/IDAES/idaes-pse). However, the C++ functions can also be used in other applications.
This section provides a basic description of the available functions and how to use them.

### Environment Varaibles

There are two ways to specify the location of data files, either through an environment varaible, or
the data file directory can be provided to the function to read parameters. The `IDAES_HELMHOLTZ_DATA_PATH`
provides a data file directory if not provided. The `IDAES_HELMHOLTZ_TEST_DATA_PATH` provides a location
to read testing data from, and is only required for the testing executable. For both environment varaibles
the string should end with the file path sperator ('\' or '/') depending on the OS.

### Reading Parameters

Before calling any property functions for a component the `uint read_params(std::string comp, std::string data_path)`
(see read_params.h) must be called. The component is the component name string.  The name is the first part of the
parameter file name in the form `{comp}_parameters.json`.  If the data path is an empty string (`""`), the function
will attempt to get the data path from the environment varaible. The ending file path seperator should be included in
the data path string.

The `read_params` function return an unsigned integer, which is an index for the componnent to be used to identify
components once the data is read.  Once parameters are read they will not be reread, and the function will just
return the index of the component string.  It is safe and reasonably efficient to call the `read_params` function
multiple times.


### Calculating Properties as a Function of Density and Temperature

The Helmholtz EoS is formulated such that the thermodynamic properties can be directly calculated as a function of
density and temperature.  The core of the Helmholtz EoS functions is in `prop.cpp` and `prop.h`.  The functions are
written in terms of delta and tau. Delta is density divided by the reducing density.  The reducing density is usually the
critical density.  Tau is reducing temperature divided by temperature.  The reducing temperature is usually the critical
temperature.  The critical properties are provided in a vector of parameter scructures indexed by the component index (see
`config.h` for the details).

For function prototypes, see `prop.h`.  All the properties have function calls in two forms.  First is 
`void {property}2(uint comp_index, double delta, double tau, f22_struct *out)`.  The data type `f22_struct`
contains the function value and first and second derivatives.  See `config.h` for the structure details.
Out will containt the function value and derivatives.

The second type of function call is `f22_struct memo2_{property}(uint comp_index, double delta, double tau)`.
This function returns the structure with the function value and derivatives. It caches the result, so if it is called
again with the same arguments the cached version can be used.  This form is useful if you expect the function may be
called multiple times with the same arguments.

### Calculating Saturation Properties

The saturation properties can be calculated as a function of tau using the method of Akasaka.

 Akasaka, R. (2008). "A Reliable and Useful Method to Determine the Saturation
     State from Helmholtz Energy Equations of State." Journal of Thermal
     Science and Technology, 3(3), 442-451.

The `sat.h` file contains prototypes for calculating the saturated liquid delta, vapor delta, 
and pressure as a function of tau.  There is also a function to calculate saturated tau from
pressure.  With delta for the phase of interest and tau, the properties of the saturated fluid
can be calculated with the functions in `prop.h`.

### Calculating Delta as a Function of Pressure and Tau

Density and temperature are not usually the most convenient choice of state varaible for modeling.
The first step to changing state varaibles is to calculate delta from temperature and pressure.
Temperature and pressure are usful state varaibles but only when the vapor fraction is known.
The `delta.h` file provides prototypes for functions for calculating the liquid or vapor density 
from temperature and pressure.  For a supercritical fluid, either the liquid or vapor dinsity
should return the correct delta result.  If a delta function is called for a phase that doesn't
exist at a given temperature and pressure, it should return a number, but the number is not
nescisarily meaningful.  

### Calculating Tau and Vapor Fraction from Other State Varaible Sets

Other choices of state variables may be more usful when the fluid phase is not known. The 
Helmholtz EoS functions allow tau and vapor fraction to be calcuated from (enthalpy, pressure),
(internal energy, pressure) and (entropy, pressure).  The enthalpy and pressure state varaibles
can be usful for open systems since it includes PV work done by fluid entering and leaving the
system.  The internal energy and pressure variables can be useful for closed systems. The 
entropy and pressure state varaibles can be useful for things like isentropic turbine or 
compressor models.

These functions work by comparing the saturated properties to the total enthalpy, internal
energy, and eneropy to determine the vapor fraction.  If the fluid is saturated, the temperature
is known and the vapor fraction can be calculated. If the fluid is single phase, the density 
function can be used with the appropriate property function to solve for tau.  Once you have
tau, pressure, and vapor fraction, you can calculate properties for each phase and for the
total mixture of phases. 

The function prototypes for the change of state varaibles are in `state.h`.



