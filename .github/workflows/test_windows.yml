name: test_windows

on: [workflow_dispatch]

jobs:
  test:
    runs-on: windows-latest
    steps:
      - name: "Install Miniconda"
        shell: powershell
        run: |
          Invoke-WebRequest -UserAgent 'DockerCI' -outfile Miniconda3-latest-Windows-x86_64.exe https://repo.anaconda.com/miniconda/Miniconda3-latest-Windows-x86_64.exe
          Start-Process Miniconda3-latest-Windows-x86_64 -ArgumentList '/InstallationType=JustMe /RegisterPython=0 /S /D=%UserProfile%\Miniconda3' -Wait
          Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
          cmd /c %UserProfile%\Miniconda3\condabin\conda.bat init
          cmd /c conda create -n idaes python=3.7.4 pip psutil git pytest

      - name: "Clone/Install IDAES-PSE"
        shell: cmd
        run: |
          conda activate idaes
          git clone https://github.com/idaes/idaes-pse.git
          cd idaes-pse
          git checkout master
          pip install --trusted-host pypi.org --trusted-host files.pythonhosted.org -r requirements.txt
          pip install -e .
          idaes get-extensions --url https://github.com/IDAES/idaes-ext/releases/download/test-release/

      - name: "Test Solvers"
        shell: cmd
        run: |
          conda activate idaes
          cd idaes-pse\idaes
          pytest tests\test_have_pynumero.py
          pytest tests\test_ipopt.py

      - name: "Test Generic Models"
        shell: cmd
        run: |
          cd \repo
          conda activate idaes
          cd idaes-pse\idaes\generic_models
          pytest

#      - name: "Test Power Models"
#        shell: cmd
#        run: |
#          cd \repo
#          conda activate idaes
#          cd idaes\power_generation
#          pytest
